<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrivCon - Messagerie Professionnelle</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Animations personnalisées */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes wave {
            0% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
            100% { transform: scaleY(0.3); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animate-pulse-slow {
            animation: pulse 2s infinite;
        }
        
        .wave-bar {
            animation: wave 1s ease-in-out infinite;
        }
        
        /* Styles Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Scrollbar personnalisée */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Canvas pour visualisation audio */
        #audio-visualizer {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            border-radius: 20px;
        }
        
        /* Styles pour l'éditeur d'image */
        .canvas-container {
            position: relative;
            max-width: 100%;
            max-height: 60vh;
            overflow: hidden;
            border-radius: 12px;
        }
        
        .drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }
        
        /* Menu contextuel */
        .context-menu {
            position: fixed;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 8px 0;
            min-width: 160px;
        }
        
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .context-menu-item:hover {
            background-color: #f3f4f6;
        }
        
        /* Interface d'appel */
        .call-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            background: #1f2937;
        }
        
        /* Indicateur de saisie */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #6b7280;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Styles pour la troncature des messages */
        .message-truncated {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .search-highlight {
            background-color: rgba(255, 255, 0, 0.3);
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* Styles pour l'enregistrement vocal */
        .voice-recorder-locked {
            background: linear-gradient(45deg, #10b981, #059669) !important;
        }

        .voice-preview {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            border-radius: 20px;
            padding: 16px;
        }
    </style>
    
    <script>
        // Configuration Tailwind
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#8b5cf6',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'pulse-slow': 'pulse 2s infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-100 dark:from-gray-900 dark:to-gray-800 min-h-screen transition-colors duration-300">
    <!-- Écran de démarrage -->
    <div id="splash-screen" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="w-24 h-24 bg-white rounded-2xl flex items-center justify-center mx-auto mb-6 animate-pulse-slow">
                <i class="fas fa-comments text-4xl text-blue-600"></i>
            </div>
            <h1 class="text-4xl font-bold mb-2">PrivCon</h1>
            <p class="text-blue-100">Messagerie Professionnelle</p>
            <div class="mt-8 flex justify-center space-x-1">
                <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.3s"></div>
            </div>
        </div>
    </div>

    <!-- Conteneur principal de l'application -->
    <div id="app-container" class="hidden">
        <!-- Vue Authentification -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center p-4 hidden">
            <div class="glass rounded-3xl p-8 max-w-md w-full shadow-2xl animate-fade-in">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-comments text-2xl text-white"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">PrivCon</h2>
                    <p class="text-gray-600 dark:text-gray-300">Connectez-vous à votre compte</p>
                </div>

                <div id="login-form">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                            <input type="email" id="login-email" 
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="votre@email.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mot de passe</label>
                            <input type="password" id="login-password" 
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="Votre mot de passe">
                        </div>
                        <button id="login-btn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 active:scale-95">
                            Se connecter
                        </button>
                    </div>

                    <div class="relative my-6">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-transparent text-gray-500 dark:text-gray-400">Ou continuer avec</span>
                        </div>
                    </div>

                    <button id="google-login-btn" class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-3 rounded-xl font-semibold hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200 flex items-center justify-center space-x-3">
                        <i class="fab fa-google text-red-500"></i>
                        <span>Google</span>
                    </button>

                    <div class="text-center mt-6">
                        <button id="show-register" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-medium transition-colors duration-200">
                            Créer un compte
                        </button>
                    </div>
                </div>

                <div id="register-form" class="hidden">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom d'utilisateur</label>
                            <input type="text" id="register-username" 
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="Choisissez un nom d'utilisateur">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                            <input type="email" id="register-email" 
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="votre@email.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mot de passe</label>
                            <input type="password" id="register-password" 
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="Créez un mot de passe sécurisé">
                        </div>
                        <button id="register-btn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 active:scale-95">
                            Créer un compte
                        </button>
                    </div>

                    <div class="text-center mt-6">
                        <button id="show-login" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-medium transition-colors duration-200">
                            Déjà un compte ? Se connecter
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vue principale après authentification -->
        <div id="main-view" class="min-h-screen pb-20 hidden">
            <!-- Header -->
            <header class="glass sticky top-0 z-10">
                <div class="px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-comments text-white text-lg"></i>
                        </div>
                        <h1 class="text-xl font-bold text-gray-800 dark:text-white" id="view-title">Messages</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="theme-toggle" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white transition-colors duration-200">
                            <i class="fas fa-moon"></i>
                        </button>
                        <div class="relative">
                            <button id="user-menu-btn" class="flex items-center space-x-2 text-gray-700 dark:text-gray-300">
                                <img id="user-avatar" src="" alt="Avatar" class="w-8 h-8 rounded-full border-2 border-white dark:border-gray-600">
                                <span id="user-name" class="font-medium"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Contenu des vues -->
            <main class="p-4">
                <!-- Vue Messages -->
                <div id="messages-view" class="view">
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="search-users" 
                                   class="w-full px-4 py-3 pl-12 pr-12 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="Rechercher des utilisateurs...">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <button id="search-users-btn" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-600 transition-colors duration-200">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="chats-list" class="space-y-2">
                        <!-- Les conversations seront chargées ici dynamiquement -->
                        <div class="text-center py-8">
                            <i class="fas fa-comments text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">Aucune conversation</p>
                            <p class="text-sm text-gray-400 dark:text-gray-500">Commencez une nouvelle conversation en recherchant un utilisateur</p>
                        </div>
                    </div>
                </div>

                <!-- Vue Appels -->
                <div id="calls-view" class="view hidden">
                    <div id="calls-list" class="space-y-3">
                        <!-- L'historique des appels sera chargé ici -->
                        <div class="text-center py-8">
                            <i class="fas fa-phone text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">Aucun appel récent</p>
                        </div>
                    </div>
                </div>

                <!-- Vue Groupes -->
                <div id="groups-view" class="view hidden">
                    <div class="mb-4 flex space-x-3">
                        <div class="relative flex-1">
                            <input type="text" id="search-groups" 
                                   class="w-full px-4 py-3 pl-12 pr-12 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="Rechercher des groupes...">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <button id="search-groups-btn" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-600 transition-colors duration-200">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                        <button id="create-group-btn" class="bg-blue-500 text-white p-3 rounded-xl hover:bg-blue-600 transition-all duration-200 transform hover:scale-105 active:scale-95">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div id="groups-list" class="space-y-3">
                        <!-- Les groupes seront chargés ici -->
                        <div class="text-center py-8">
                            <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">Aucun groupe</p>
                            <p class="text-sm text-gray-400 dark:text-gray-500">Rejoignez ou créez un groupe pour commencer</p>
                        </div>
                    </div>
                </div>

                <!-- Vue Paramètres -->
                <div id="settings-view" class="view hidden">
                    <div class="glass rounded-2xl p-6 mb-4">
                        <div class="flex items-center space-x-4 mb-6">
                            <img id="profile-avatar" src="" alt="Avatar" class="w-20 h-20 rounded-2xl border-4 border-white dark:border-gray-600">
                            <div>
                                <h3 id="profile-name" class="text-xl font-bold text-gray-800 dark:text-white"></h3>
                                <p id="profile-email" class="text-gray-600 dark:text-gray-400 text-sm"></p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom d'utilisateur</label>
                                <input type="text" id="profile-username" 
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bio</label>
                                <textarea id="profile-bio" rows="3"
                                          class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none"
                                          placeholder="Parlez de vous..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Localisation</label>
                                <input type="text" id="profile-location" 
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                       placeholder="Votre ville">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Photo de profil</label>
                                <input type="file" id="profile-photo" accept="image/*" class="hidden">
                                <button id="change-photo-btn" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200">
                                    Changer la photo
                                </button>
                            </div>
                            <div class="flex items-center justify-between pt-4">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Mode sombre</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex space-x-3">
                            <button id="save-profile-btn" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-semibold hover:bg-blue-600 transition-all duration-200">
                                Enregistrer
                            </button>
                            <button id="logout-btn" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-semibold hover:bg-red-600 transition-all duration-200">
                                Déconnexion
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Vue Chat (s'ouvre par-dessus les autres vues) -->
                <div id="chat-view" class="fixed inset-0 bg-white dark:bg-gray-900 z-20 transform translate-x-full transition-transform duration-300">
                    <!-- Header du chat -->
                    <div class="glass sticky top-0 z-10">
                        <div class="px-4 py-3 flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <button id="back-to-messages" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white transition-colors duration-200">
                                    <i class="fas fa-arrow-left text-xl"></i>
                                </button>
                                <img id="chat-user-avatar" src="" alt="Avatar" class="w-10 h-10 rounded-xl">
                                <div>
                                    <h2 id="chat-user-name" class="font-semibold text-gray-800 dark:text-white">Utilisateur</h2>
                                    <p id="chat-user-status" class="text-sm text-gray-600 dark:text-gray-400">En ligne</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button id="audio-call-btn" class="text-gray-600 dark:text-gray-300 hover:text-blue-500 transition-colors duration-200">
                                    <i class="fas fa-phone-alt text-lg"></i>
                                </button>
                                <button id="video-call-btn" class="text-gray-600 dark:text-gray-300 hover:text-blue-500 transition-colors duration-200">
                                    <i class="fas fa-video text-lg"></i>
                                </button>
                                <button id="chat-info-btn" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white transition-colors duration-200">
                                    <i class="fas fa-info-circle text-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div id="messages-container" class="flex-1 p-4 space-y-4 overflow-y-auto custom-scrollbar max-h-[calc(100vh-140px)]">
                        <!-- Les messages seront chargés ici -->
                    </div>

                    <!-- Zone de saisie -->
                    <div class="glass sticky bottom-0 p-4">
                        <!-- Indicateur de réponse -->
                        <div id="reply-indicator" class="mb-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-xl hidden">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Réponse à <span id="reply-user-name">Utilisateur</span></p>
                                    <p id="reply-message-text" class="text-sm text-gray-500 dark:text-gray-400 truncate"></p>
                                </div>
                                <button id="cancel-reply" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex items-end space-x-3">
                            <button id="attachment-btn" class="text-gray-600 dark:text-gray-300 hover:text-blue-500 transition-colors duration-200 p-2">
                                <i class="fas fa-paperclip text-xl"></i>
                            </button>
                            
                            <div class="flex-1 relative">
                                <textarea id="message-input" rows="1"
                                          class="w-full px-4 py-3 pr-12 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none max-h-32"
                                          placeholder="Tapez votre message..."></textarea>
                                
                                <!-- Enregistrement vocal -->
                                <div id="voice-recorder" class="hidden absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-3">
                                    <div class="flex items-center justify-between h-full">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-6 h-6 bg-red-500 rounded-full animate-pulse"></div>
                                            <span class="text-white font-medium">Enregistrement...</span>
                                        </div>
                                        <div id="audio-visualizer" class="flex items-center space-x-1 h-8 px-2 rounded-full">
                                            <!-- Barres de visualisation audio -->
                                            <div class="wave-bar w-1 bg-white rounded-full" style="height: 20%; animation-delay: 0s"></div>
                                            <div class="wave-bar w-1 bg-white rounded-full" style="height: 40%; animation-delay: 0.1s"></div>
                                            <div class="wave-bar w-1 bg-white rounded-full" style="height: 60%; animation-delay: 0.2s"></div>
                                            <div class="wave-bar w-1 bg-white rounded-full" style="height: 80%; animation-delay: 0.3s"></div>
                                            <div class="wave-bar w-1 bg-white rounded-full" style="height: 100%; animation-delay: 0.4s"></div>
                                        </div>
                                        <button id="send-recording" class="text-white">
                                            <i class="fas fa-paper-plane text-lg"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Prévisualisation audio -->
                                <div id="voice-preview" class="hidden absolute inset-0 voice-preview">
                                    <div class="flex items-center justify-between h-full px-4">
                                        <div class="flex items-center space-x-3">
                                            <button id="play-preview" class="text-white">
                                                <i class="fas fa-play text-xl"></i>
                                            </button>
                                            <span class="text-white font-medium">Prévisualisation audio</span>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button id="cancel-preview" class="text-white hover:text-gray-200">
                                                <i class="fas fa-times text-lg"></i>
                                            </button>
                                            <button id="confirm-send-voice" class="text-white">
                                                <i class="fas fa-paper-plane text-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button id="mic-btn" class="text-gray-600 dark:text-gray-300 hover:text-blue-500 transition-colors duration-200 p-2">
                                <i class="fas fa-microphone text-xl"></i>
                            </button>
                            
                            <button id="send-btn" class="bg-blue-500 text-white p-3 rounded-xl hover:bg-blue-600 transition-all duration-200 transform hover:scale-105 active:scale-95 hidden">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Vue Chat de Groupe -->
                <div id="group-chat-view" class="fixed inset-0 bg-white dark:bg-gray-900 z-20 transform translate-x-full transition-transform duration-300">
                    <!-- Structure similaire à chat-view mais pour les groupes -->
                </div>

                <!-- Panneau d'information du chat -->
                <div id="chat-info-panel" class="fixed inset-0 bg-white dark:bg-gray-900 z-20 transform translate-x-full transition-transform duration-300">
                    <div class="p-4">
                        <div class="flex items-center space-x-3 mb-6">
                            <button id="back-to-chat" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white transition-colors duration-200">
                                <i class="fas fa-arrow-left text-xl"></i>
                            </button>
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white">Informations</h2>
                        </div>

                        <div id="chat-info-content">
                            <!-- Contenu des informations du chat -->
                        </div>

                        <!-- Recherche de messages dans la conversation -->
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Rechercher dans la conversation</h3>
                            <div class="relative">
                                <input type="text" id="search-messages" 
                                       class="w-full px-4 py-3 pl-12 pr-12 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                       placeholder="Rechercher des messages...">
                                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <button id="search-messages-btn" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-600 transition-colors duration-200">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            <div id="search-results" class="mt-4 space-y-2 max-h-64 overflow-y-auto">
                                <!-- Résultats de recherche -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Navigation mobile -->
            <nav class="glass fixed bottom-0 left-0 right-0 z-10">
                <div class="flex justify-around items-center py-3">
                    <button class="nav-tab flex flex-col items-center space-y-1 text-gray-600 dark:text-gray-400 transition-colors duration-200" data-view="calls-view">
                        <i class="fas fa-phone text-lg"></i>
                        <span class="text-xs">Appels</span>
                    </button>
                    <button class="nav-tab flex flex-col items-center space-y-1 text-blue-500 transition-colors duration-200" data-view="messages-view">
                        <i class="fas fa-comments text-lg"></i>
                        <span class="text-xs">Messages</span>
                    </button>
                    <button class="nav-tab flex flex-col items-center space-y-1 text-gray-600 dark:text-gray-400 transition-colors duration-200" data-view="groups-view">
                        <i class="fas fa-users text-lg"></i>
                        <span class="text-xs">Groupes</span>
                    </button>
                    <button class="nav-tab flex flex-col items-center space-y-1 text-gray-600 dark:text-gray-400 transition-colors duration-200" data-view="settings-view">
                        <i class="fas fa-cog text-lg"></i>
                        <span class="text-xs">Paramètres</span>
                    </button>
                </div>
            </nav>
        </div>
    </div>

    <!-- Modales et overlays -->
    
    <!-- Éditeur de média avancé -->
    <div id="media-editor-modal" class="fixed inset-0 bg-black bg-opacity-75 z-40 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Éditer le média</h3>
                <button id="close-media-editor" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-4">
                <div class="canvas-container bg-gray-100 dark:bg-gray-700 rounded-xl mb-4">
                    <img id="media-preview" src="" alt="Preview" class="max-w-full max-h-96 object-contain">
                    <canvas id="drawing-canvas" class="drawing-canvas"></canvas>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button id="draw-tool" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center">
                        <i class="fas fa-pen mr-2"></i>Dessiner
                    </button>
                    <button id="text-tool" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors duration-200 flex items-center justify-center">
                        <i class="fas fa-font mr-2"></i>Texte
                    </button>
                    <button id="crop-tool" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors duration-200 flex items-center justify-center">
                        <i class="fas fa-crop mr-2"></i>Recadrer
                    </button>
                    <button id="filter-tool" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors duration-200 flex items-center justify-center">
                        <i class="fas fa-sliders-h mr-2"></i>Filtres
                    </button>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <div class="flex space-x-2">
                        <button id="clear-canvas" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200">
                            <i class="fas fa-eraser mr-2"></i>Effacer
                        </button>
                    </div>
                    
                    <input type="color" id="drawing-color" value="#3b82f6" class="w-10 h-10 rounded-lg border-0">
                </div>
                
                <div id="text-input-container" class="hidden mb-4">
                    <input type="text" id="text-input" placeholder="Entrez votre texte..." 
                           class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>

                <div id="filter-container" class="hidden mb-4">
                    <div class="grid grid-cols-3 gap-2">
                        <button class="filter-option px-3 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500" data-filter="none">Original</button>
                        <button class="filter-option px-3 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500" data-filter="grayscale">Noir & Blanc</button>
                        <button class="filter-option px-3 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500" data-filter="sepia">Sépia</button>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <button id="download-media" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors duration-200">
                    <i class="fas fa-download mr-2"></i>Télécharger
                </button>
                <button id="cancel-media" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors duration-200">
                    Annuler
                </button>
                <button id="send-media" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200">
                    Envoyer
                </button>
            </div>
        </div>
    </div>

    <!-- Interface d'appel -->
    <div id="call-interface" class="call-interface hidden">
        <video id="remote-video" autoplay muted class="w-full h-full object-cover"></video>
        <video id="local-video" autoplay muted class="absolute top-4 right-4 w-32 h-48 object-cover rounded-2xl border-2 border-white"></video>
        
        <div class="absolute top-4 left-4 text-white">
            <h3 id="call-user-name" class="text-xl font-semibold">Utilisateur</h3>
            <p id="call-status" class="text-blue-200">Appel en cours...</p>
        </div>
        
        <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex space-x-6">
            <button id="call-mute" class="w-14 h-14 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-white hover:bg-opacity-30 transition-all duration-200">
                <i class="fas fa-microphone text-xl"></i>
            </button>
            <button id="call-end" class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center text-white hover:bg-red-600 transition-all duration-200 transform hover:scale-105">
                <i class="fas fa-phone-slash text-xl"></i>
            </button>
            <button id="call-camera" class="w-14 h-14 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-white hover:bg-opacity-30 transition-all duration-200">
                <i class="fas fa-video text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Appel entrant -->
    <div id="incoming-call" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-sm w-full mx-4 text-center">
            <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-phone text-2xl text-white"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2" id="incoming-call-name">Appel entrant</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6" id="incoming-call-type">Appel audio</p>
            
            <div class="flex justify-center space-x-6">
                <button id="decline-call" class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center text-white hover:bg-red-600 transition-all duration-200 transform hover:scale-105">
                    <i class="fas fa-phone-slash text-xl"></i>
                </button>
                <button id="accept-call" class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center text-white hover:bg-green-600 transition-all duration-200 transform hover:scale-105">
                    <i class="fas fa-phone text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modale de création de groupe -->
    <div id="create-group-modal" class="fixed inset-0 bg-black bg-opacity-75 z-40 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-md w-full max-h-[90vh] overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Créer un groupe</h3>
                <button id="close-create-group" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom du groupe</label>
                        <input type="text" id="group-name" 
                               class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                               placeholder="Nom du groupe">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                        <textarea id="group-description" rows="3"
                                  class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none"
                                  placeholder="Description du groupe"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Photo du groupe</label>
                        <input type="file" id="group-photo" accept="image/*" class="hidden">
                        <button id="change-group-photo-btn" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200">
                            Changer la photo
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <button id="cancel-create-group" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors duration-200">
                    Annuler
                </button>
                <button id="confirm-create-group" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200">
                    Créer
                </button>
            </div>
        </div>
    </div>

    <!-- Modale d'ajout de membres -->
    <div id="add-members-modal" class="fixed inset-0 bg-black bg-opacity-75 z-40 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-md w-full max-h-[90vh] overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Ajouter des membres</h3>
                <button id="close-add-members" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-4">
                <div class="relative mb-4">
                    <input type="text" id="search-members" 
                           class="w-full px-4 py-3 pl-12 pr-12 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                           placeholder="Rechercher des utilisateurs...">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <button id="search-members-btn" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-600 transition-colors duration-200">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <div id="members-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Liste des utilisateurs à ajouter -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3"></div>

    <!-- Input fichier caché -->
    <input type="file" id="file-input" class="hidden" accept="image/*,video/*">
    <input type="file" id="group-photo-input" class="hidden" accept="image/*">

    <script>
        // =====================================================
        // CONFIGURATION ET INITIALISATION
        // =====================================================

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD6SwKXKgGrUeCTfeMFn7pToWbZuLQNiQk",
            authDomain: "priccon.firebaseapp.com",
            projectId: "priccon",
            storageBucket: "priccon.firebasestorage.app",
            messagingSenderId: "590409094566",
            appId: "1:590409094566:web:e6f548231d95cfd0062b67"
        };

        // Configuration Cloudinary
        const CLOUD_NAME = "djbp8wvsw";
        const UPLOAD_PRESET = "privcon_upload";

        // Configuration WebRTC
        const ICE_SERVERS = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // Initialisation Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // État global de l'application
        let currentUser = null;
        let currentChat = null;
        let currentGroup = null;
        let peerConnection = null;
        let localStream = null;
        let remoteStream = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let isVoiceLocked = false;
        let replyingToMessage = null;
        let currentCallDoc = null;
        let currentMediaFile = null;
        let expandedMessages = new Set(); // Pour suivre les messages développés
        
        // Variables pour gérer les listeners Firestore
        let unsubscribeChatListener = null;
        let unsubscribeMessagesListener = null;
        let unsubscribeUsersListener = null;
        let unsubscribeGroupsListener = null;
        let unsubscribeCallsListener = null;

        // Variables pour l'enregistrement vocal
        let audioPreview = null;
        let isPlayingPreview = false;
        let voiceRecordingStartY = 0;

        // Éléments DOM
        const elements = {
            // Vues principales
            splashScreen: document.getElementById('splash-screen'),
            appContainer: document.getElementById('app-container'),
            authView: document.getElementById('auth-view'),
            mainView: document.getElementById('main-view'),
            
            // Authentification
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            showRegister: document.getElementById('show-register'),
            showLogin: document.getElementById('show-login'),
            loginBtn: document.getElementById('login-btn'),
            registerBtn: document.getElementById('register-btn'),
            googleLoginBtn: document.getElementById('google-login-btn'),
            
            // Navigation
            navTabs: document.querySelectorAll('.nav-tab'),
            viewTitle: document.getElementById('view-title'),
            themeToggle: document.getElementById('theme-toggle'),
            
            // Profil
            userAvatar: document.getElementById('user-avatar'),
            userName: document.getElementById('user-name'),
            profileAvatar: document.getElementById('profile-avatar'),
            profileName: document.getElementById('profile-name'),
            profileEmail: document.getElementById('profile-email'),
            profileUsername: document.getElementById('profile-username'),
            profileBio: document.getElementById('profile-bio'),
            profileLocation: document.getElementById('profile-location'),
            changePhotoBtn: document.getElementById('change-photo-btn'),
            profilePhoto: document.getElementById('profile-photo'),
            saveProfileBtn: document.getElementById('save-profile-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            
            // Messages
            searchUsers: document.getElementById('search-users'),
            searchUsersBtn: document.getElementById('search-users-btn'),
            chatsList: document.getElementById('chats-list'),
            chatView: document.getElementById('chat-view'),
            backToMessages: document.getElementById('back-to-messages'),
            chatUserAvatar: document.getElementById('chat-user-avatar'),
            chatUserName: document.getElementById('chat-user-name'),
            chatUserStatus: document.getElementById('chat-user-status'),
            messagesContainer: document.getElementById('messages-container'),
            messageInput: document.getElementById('message-input'),
            attachmentBtn: document.getElementById('attachment-btn'),
            micBtn: document.getElementById('mic-btn'),
            sendBtn: document.getElementById('send-btn'),
            fileInput: document.getElementById('file-input'),
            
            // Enregistrement vocal
            voiceRecorder: document.getElementById('voice-recorder'),
            sendRecording: document.getElementById('send-recording'),
            voicePreview: document.getElementById('voice-preview'),
            playPreview: document.getElementById('play-preview'),
            cancelPreview: document.getElementById('cancel-preview'),
            confirmSendVoice: document.getElementById('confirm-send-voice'),
            
            // Réponse aux messages
            replyIndicator: document.getElementById('reply-indicator'),
            replyUserName: document.getElementById('reply-user-name'),
            replyMessageText: document.getElementById('reply-message-text'),
            cancelReply: document.getElementById('cancel-reply'),
            
            // Appels
            audioCallBtn: document.getElementById('audio-call-btn'),
            videoCallBtn: document.getElementById('video-call-btn'),
            callInterface: document.getElementById('call-interface'),
            remoteVideo: document.getElementById('remote-video'),
            localVideo: document.getElementById('local-video'),
            callUserName: document.getElementById('call-user-name'),
            callStatus: document.getElementById('call-status'),
            callMute: document.getElementById('call-mute'),
            callEnd: document.getElementById('call-end'),
            callCamera: document.getElementById('call-camera'),
            incomingCall: document.getElementById('incoming-call'),
            incomingCallName: document.getElementById('incoming-call-name'),
            incomingCallType: document.getElementById('incoming-call-type'),
            declineCall: document.getElementById('decline-call'),
            acceptCall: document.getElementById('accept-call'),
            
            // Éditeur de média avancé
            mediaEditorModal: document.getElementById('media-editor-modal'),
            mediaPreview: document.getElementById('media-preview'),
            drawingCanvas: document.getElementById('drawing-canvas'),
            drawTool: document.getElementById('draw-tool'),
            textTool: document.getElementById('text-tool'),
            cropTool: document.getElementById('crop-tool'),
            filterTool: document.getElementById('filter-tool'),
            clearCanvas: document.getElementById('clear-canvas'),
            drawingColor: document.getElementById('drawing-color'),
            textInputContainer: document.getElementById('text-input-container'),
            textInput: document.getElementById('text-input'),
            filterContainer: document.getElementById('filter-container'),
            closeMediaEditor: document.getElementById('close-media-editor'),
            cancelMedia: document.getElementById('cancel-media'),
            sendMedia: document.getElementById('send-media'),
            downloadMedia: document.getElementById('download-media'),
            
            // Groupes
            groupsView: document.getElementById('groups-view'),
            searchGroups: document.getElementById('search-groups'),
            searchGroupsBtn: document.getElementById('search-groups-btn'),
            createGroupBtn: document.getElementById('create-group-btn'),
            groupsList: document.getElementById('groups-list'),
            createGroupModal: document.getElementById('create-group-modal'),
            closeCreateGroup: document.getElementById('close-create-group'),
            cancelCreateGroup: document.getElementById('cancel-create-group'),
            confirmCreateGroup: document.getElementById('confirm-create-group'),
            groupName: document.getElementById('group-name'),
            groupDescription: document.getElementById('group-description'),
            groupPhoto: document.getElementById('group-photo'),
            changeGroupPhotoBtn: document.getElementById('change-group-photo-btn'),
            addMembersModal: document.getElementById('add-members-modal'),
            closeAddMembers: document.getElementById('close-add-members'),
            searchMembers: document.getElementById('search-members'),
            searchMembersBtn: document.getElementById('search-members-btn'),
            membersList: document.getElementById('members-list'),
            
            // Recherche de messages
            chatInfoBtn: document.getElementById('chat-info-btn'),
            chatInfoPanel: document.getElementById('chat-info-panel'),
            backToChat: document.getElementById('back-to-chat'),
            chatInfoContent: document.getElementById('chat-info-content'),
            searchMessages: document.getElementById('search-messages'),
            searchMessagesBtn: document.getElementById('search-messages-btn'),
            searchResults: document.getElementById('search-results'),
            
            // Notifications
            toastContainer: document.getElementById('toast-container')
        };

        // =====================================================
        // INITIALISATION DE L'APPLICATION
        // =====================================================

        document.addEventListener('DOMContentLoaded', function() {
            // Afficher l'écran de démarrage pendant 4 secondes
            setTimeout(() => {
                elements.splashScreen.classList.add('hidden');
                elements.appContainer.classList.remove('hidden');
                initializeApp();
            }, 4000);
        });

        function initializeApp() {
            setupEventListeners();
            checkAuthState();
            initializeTheme();
        }

        function setupEventListeners() {
            // Authentification
            elements.showRegister.addEventListener('click', showRegisterForm);
            elements.showLogin.addEventListener('click', showLoginForm);
            elements.loginBtn.addEventListener('click', loginWithEmail);
            elements.registerBtn.addEventListener('click', registerWithEmail);
            elements.googleLoginBtn.addEventListener('click', loginWithGoogle);
            
            // Navigation
            elements.navTabs.forEach(tab => {
                tab.addEventListener('click', () => switchView(tab.dataset.view));
            });
            
            elements.themeToggle.addEventListener('click', toggleTheme);
            elements.darkModeToggle.addEventListener('change', toggleDarkMode);
            
            // Profil
            elements.changePhotoBtn.addEventListener('click', () => elements.profilePhoto.click());
            elements.profilePhoto.addEventListener('change', handleProfilePhotoChange);
            elements.saveProfileBtn.addEventListener('click', saveProfile);
            elements.logoutBtn.addEventListener('click', logout);
            
            // Messages
            elements.backToMessages.addEventListener('click', hideChatView);
            elements.searchUsersBtn.addEventListener('click', performUserSearch);
            elements.searchUsers.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performUserSearch();
            });
            elements.messageInput.addEventListener('input', handleMessageInput);
            elements.messageInput.addEventListener('keypress', handleMessageKeypress);
            elements.attachmentBtn.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileUpload);
            
            // Enregistrement vocal amélioré
            elements.micBtn.addEventListener('mousedown', startVoiceRecording);
            elements.micBtn.addEventListener('touchstart', handleVoiceRecordingStart);
            document.addEventListener('mouseup', stopVoiceRecording);
            document.addEventListener('touchend', stopVoiceRecording);
            document.addEventListener('mousemove', handleVoiceRecordingMove);
            document.addEventListener('touchmove', handleVoiceRecordingMove);
            
            elements.sendBtn.addEventListener('click', sendMessage);
            elements.sendRecording.addEventListener('click', sendVoiceRecording);
            elements.cancelReply.addEventListener('click', cancelReply);
            
            // Prévisualisation audio
            elements.playPreview.addEventListener('click', toggleAudioPreview);
            elements.cancelPreview.addEventListener('click', cancelVoicePreview);
            elements.confirmSendVoice.addEventListener('click', confirmSendVoiceRecording);
            
            // Appels
            elements.audioCallBtn.addEventListener('click', () => startCall('audio'));
            elements.videoCallBtn.addEventListener('click', () => startCall('video'));
            elements.callEnd.addEventListener('click', endCall);
            elements.callMute.addEventListener('click', toggleMute);
            elements.declineCall.addEventListener('click', declineIncomingCall);
            elements.acceptCall.addEventListener('click', acceptIncomingCall);
            
            // Éditeur de média avancé
            elements.drawTool.addEventListener('click', activateDrawTool);
            elements.textTool.addEventListener('click', activateTextTool);
            elements.cropTool.addEventListener('click', activateCropTool);
            elements.filterTool.addEventListener('click', activateFilterTool);
            elements.clearCanvas.addEventListener('click', clearCanvas);
            elements.drawingColor.addEventListener('change', updateDrawingColor);
            elements.closeMediaEditor.addEventListener('click', closeMediaEditor);
            elements.cancelMedia.addEventListener('click', closeMediaEditor);
            elements.sendMedia.addEventListener('click', sendEditedMedia);
            elements.downloadMedia.addEventListener('click', downloadEditedMedia);
            
            // Filtres d'image
            document.querySelectorAll('.filter-option').forEach(button => {
                button.addEventListener('click', (e) => {
                    applyFilter(e.target.dataset.filter);
                });
            });
            
            // Groupes
            elements.createGroupBtn.addEventListener('click', showCreateGroupModal);
            elements.closeCreateGroup.addEventListener('click', hideCreateGroupModal);
            elements.cancelCreateGroup.addEventListener('click', hideCreateGroupModal);
            elements.confirmCreateGroup.addEventListener('click', createGroup);
            elements.changeGroupPhotoBtn.addEventListener('click', () => elements.groupPhoto.click());
            elements.groupPhoto.addEventListener('change', handleGroupPhotoChange);
            elements.searchGroupsBtn.addEventListener('click', performGroupSearch);
            elements.searchGroups.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performGroupSearch();
            });
            
            // Recherche de messages
            elements.chatInfoBtn.addEventListener('click', showChatInfoPanel);
            elements.backToChat.addEventListener('click', hideChatInfoPanel);
            elements.searchMessagesBtn.addEventListener('click', performMessageSearch);
            elements.searchMessages.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performMessageSearch();
            });
        }

        // =====================================================
        // CORRECTION DES BUGS DE DUPLICATION
        // =====================================================

        function cleanupListeners() {
            // Nettoyer tous les listeners Firestore
            if (unsubscribeMessagesListener) {
                unsubscribeMessagesListener();
                unsubscribeMessagesListener = null;
            }
            
            if (unsubscribeUsersListener) {
                unsubscribeUsersListener();
                unsubscribeUsersListener = null;
            }
            
            if (unsubscribeGroupsListener) {
                unsubscribeGroupsListener();
                unsubscribeGroupsListener = null;
            }
            
            if (unsubscribeCallsListener) {
                unsubscribeCallsListener();
                unsubscribeCallsListener = null;
            }
            
            if (unsubscribeChatListener) {
                unsubscribeChatListener();
                unsubscribeChatListener = null;
            }
        }

        function switchView(viewId) {
            // Nettoyer les listeners avant de changer de vue
            cleanupListeners();
            
            // Mettre à jour les onglets de navigation
            elements.navTabs.forEach(tab => {
                if (tab.dataset.view === viewId) {
                    tab.classList.remove('text-gray-600', 'dark:text-gray-400');
                    tab.classList.add('text-blue-500');
                } else {
                    tab.classList.remove('text-blue-500');
                    tab.classList.add('text-gray-600', 'dark:text-gray-400');
                }
            });
            
            // Masquer toutes les vues
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            
            // Afficher la vue sélectionnée
            document.getElementById(viewId).classList.remove('hidden');
            
            // Mettre à jour le titre
            const titles = {
                'messages-view': 'Messages',
                'calls-view': 'Appels',
                'groups-view': 'Groupes',
                'settings-view': 'Paramètres'
            };
            elements.viewTitle.textContent = titles[viewId] || 'PrivCon';
            
            // Charger les données spécifiques à la vue
            if (viewId === 'messages-view') {
                loadChatsList();
            } else if (viewId === 'calls-view') {
                loadCallsHistory();
            } else if (viewId === 'groups-view') {
                loadGroupsList();
            }
        }

        // =====================================================
        // GESTION DE L'AUTHENTIFICATION
        // =====================================================

        function checkAuthState() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showMainApp();
                    setupUserData();
                    setupRealtimeListeners();
                } else {
                    showAuthView();
                }
            });
        }

        function showAuthView() {
            elements.authView.classList.remove('hidden');
            elements.mainView.classList.add('hidden');
        }

        function showMainApp() {
            elements.authView.classList.add('hidden');
            elements.mainView.classList.remove('hidden');
            switchView('messages-view');
        }

        function showRegisterForm() {
            elements.loginForm.classList.add('hidden');
            elements.registerForm.classList.remove('hidden');
        }

        function showLoginForm() {
            elements.registerForm.classList.add('hidden');
            elements.loginForm.classList.remove('hidden');
        }

        async function loginWithEmail() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showToast('Connexion réussie', 'success');
            } catch (error) {
                showToast('Erreur de connexion: ' + error.message, 'error');
            }
        }

        async function registerWithEmail() {
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!username || !email || !password) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Le mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    username: username,
                    email: email,
                    photoURL: '',
                    bio: '',
                    location: '',
                    isOnline: true,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    dateJoined: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Compte créé avec succès', 'success');
            } catch (error) {
                showToast('Erreur lors de la création du compte: ' + error.message, 'error');
            }
        }

        async function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    username: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    photoURL: user.photoURL || '',
                    bio: '',
                    location: '',
                    isOnline: true,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    dateJoined: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                showToast('Connexion Google réussie', 'success');
            } catch (error) {
                showToast('Erreur de connexion Google: ' + error.message, 'error');
            }
        }

        async function logout() {
            try {
                if (currentUser) {
                    await db.collection('users').doc(currentUser.uid).update({
                        isOnline: false,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                if (peerConnection) {
                    peerConnection.close();
                }
                
                // Nettoyer tous les listeners
                cleanupListeners();
                
                await auth.signOut();
                showToast('Déconnexion réussie', 'success');
            } catch (error) {
                showToast('Erreur de déconnexion: ' + error.message, 'error');
            }
        }

        // =====================================================
        // GESTION DU PROFIL UTILISATEUR
        // =====================================================

        function setupUserData() {
            if (!currentUser) return;
            
            unsubscribeUsersListener = db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    
                    // Mettre à jour l'interface
                    elements.userName.textContent = userData.username;
                    elements.profileName.textContent = userData.username;
                    elements.profileEmail.textContent = userData.email;
                    elements.profileUsername.value = userData.username;
                    elements.profileBio.value = userData.bio || '';
                    elements.profileLocation.value = userData.location || '';
                    
                    // Mettre à jour les avatars
                    const avatarUrl = userData.photoURL || 'https://via.placeholder.com/150';
                    elements.userAvatar.src = avatarUrl;
                    elements.profileAvatar.src = avatarUrl;
                }
            });
        }

        async function handleProfilePhotoChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const result = await uploadToCloudinary(file, 'image');
                await db.collection('users').doc(currentUser.uid).update({
                    photoURL: result.secure_url
                });
                showToast('Photo de profil mise à jour', 'success');
            } catch (error) {
                showToast('Erreur lors du changement de photo: ' + error.message, 'error');
            }
        }

        async function saveProfile() {
            const username = elements.profileUsername.value.trim();
            const bio = elements.profileBio.value.trim();
            const location = elements.profileLocation.value.trim();
            
            if (!username) {
                showToast('Le nom d\'utilisateur est requis', 'error');
                return;
            }
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    username: username,
                    bio: bio,
                    location: location
                });
                showToast('Profil mis à jour avec succès', 'success');
            } catch (error) {
                showToast('Erreur lors de la mise à jour du profil: ' + error.message, 'error');
            }
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                elements.themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                elements.darkModeToggle.checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                elements.themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                elements.darkModeToggle.checked = false;
            }
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                elements.themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                elements.darkModeToggle.checked = false;
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                elements.themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                elements.darkModeToggle.checked = true;
            }
        }

        function toggleDarkMode() {
            if (elements.darkModeToggle.checked) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                elements.themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                elements.themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        // =====================================================
        // MESSAGERIE ET CHATS - CORRECTIONS ET AMÉLIORATIONS
        // =====================================================

        async function performUserSearch() {
            const query = elements.searchUsers.value.trim();
            if (!query) {
                loadChatsList();
                return;
            }
            
            try {
                const snapshot = await db.collection('users')
                    .where('username', '>=', query)
                    .where('username', '<=', query + '\uf8ff')
                    .get();
                
                // Vider le conteneur avant d'ajouter de nouveaux éléments
                elements.chatsList.innerHTML = '';
                
                if (snapshot.empty) {
                    elements.chatsList.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">Aucun utilisateur trouvé</p>
                        </div>
                    `;
                    return;
                }
                
                // Utiliser un Set pour éviter les doublons
                const displayedUsers = new Set();
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.uid === currentUser.uid || displayedUsers.has(user.uid)) return;
                    
                    displayedUsers.add(user.uid);
                    const chatItem = createUserChatItem(user);
                    elements.chatsList.appendChild(chatItem);
                });
            } catch (error) {
                console.error('Erreur de recherche:', error);
            }
        }

        function createUserChatItem(user) {
            const div = document.createElement('div');
            div.className = 'glass rounded-2xl p-4 flex items-center space-x-3 cursor-pointer hover:bg-white dark:hover:bg-gray-700 transition-colors duration-200';
            div.innerHTML = `
                <img src="${user.photoURL || 'https://via.placeholder.com/50'}" alt="${user.username}" class="w-12 h-12 rounded-xl">
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-800 dark:text-white">${user.username}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${user.email}</p>
                </div>
                <div class="w-3 h-3 rounded-full ${user.isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
            `;
            
            div.addEventListener('click', () => openChatWithUser(user.uid, user.username));
            return div;
        }

        async function openChatWithUser(otherUserId, otherUserName) {
            const chatId = [currentUser.uid, otherUserId].sort().join('_');
            
            try {
                const chatRef = db.collection('chats').doc(chatId);
                const chatDoc = await chatRef.get();
                
                if (!chatDoc.exists) {
                    await chatRef.set({
                        participants: [currentUser.uid, otherUserId],
                        lastMessage: '',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                currentChat = {
                    id: chatId,
                    otherUserId: otherUserId,
                    name: otherUserName
                };
                
                showChatView();
                loadChatMessages();
                setupChatListener();
            } catch (error) {
                showToast('Erreur lors de l\'ouverture du chat: ' + error.message, 'error');
            }
        }

        function showChatView() {
            elements.chatView.classList.remove('translate-x-full');
            elements.chatUserName.textContent = currentChat.name;
            
            // Charger les informations de l'utilisateur pour l'avatar et le statut
            db.collection('users').doc(currentChat.otherUserId).get().then(doc => {
                if (doc.exists) {
                    const user = doc.data();
                    elements.chatUserAvatar.src = user.photoURL || 'https://via.placeholder.com/50';
                    elements.chatUserStatus.textContent = user.isOnline ? 'En ligne' : 'Hors ligne';
                }
            });
        }

        function hideChatView() {
            elements.chatView.classList.add('translate-x-full');
            currentChat = null;
            replyingToMessage = null;
            elements.replyIndicator.classList.add('hidden');
            
            // Nettoyer le listener des messages
            if (unsubscribeMessagesListener) {
                unsubscribeMessagesListener();
                unsubscribeMessagesListener = null;
            }
        }

        function loadChatMessages() {
            if (!currentChat) return;
            
            // Vider le conteneur avant de charger de nouveaux messages
            elements.messagesContainer.innerHTML = '';
            
            db.collection('chats').doc(currentChat.id).collection('messages')
                .orderBy('timestamp', 'asc')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        elements.messagesContainer.innerHTML = `
                            <div class="text-center py-8">
                                <i class="fas fa-comment-slash text-4xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500 dark:text-gray-400">Aucun message</p>
                                <p class="text-sm text-gray-400 dark:text-gray-500">Envoyez le premier message !</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Utiliser un Set pour éviter les doublons
                    const displayedMessages = new Set();
                    
                    snapshot.forEach(doc => {
                        if (displayedMessages.has(doc.id)) return;
                        
                        displayedMessages.add(doc.id);
                        displayMessage(doc.data(), doc.id);
                    });
                    
                    scrollToBottom();
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des messages:', error);
                });
        }

        function setupChatListener() {
            if (!currentChat) return;
            
            // Nettoyer l'ancien listener s'il existe
            if (unsubscribeMessagesListener) {
                unsubscribeMessagesListener();
            }
            
            unsubscribeMessagesListener = db.collection('chats').doc(currentChat.id).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    // Ne pas vider le conteneur, mais mettre à jour les messages
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            // Vérifier si le message n'est pas déjà affiché
                            const messageElement = document.getElementById(`message-${change.doc.id}`);
                            if (!messageElement) {
                                displayMessage(change.doc.data(), change.doc.id);
                            }
                        } else if (change.type === 'modified') {
                            // Mettre à jour le message existant
                            updateMessage(change.doc.data(), change.doc.id);
                        } else if (change.type === 'removed') {
                            // Supprimer le message
                            removeMessage(change.doc.id);
                        }
                    });
                    scrollToBottom();
                });
        }

        function displayMessage(message, messageId) {
            const isCurrentUser = message.senderId === currentUser.uid;
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
            messageElement.id = `message-${messageId}`;
            
            let messageContent = '';
            if (message.mediaUrl) {
                if (message.mediaType === 'image') {
                    messageContent = `
                        <div class="relative">
                            <img src="${message.mediaUrl}" alt="Image" class="max-w-xs rounded-2xl cursor-pointer" onclick="openImageModal('${message.mediaUrl}')">
                            <button class="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition-all duration-200" onclick="downloadMedia('${message.mediaUrl}', 'image')">
                                <i class="fas fa-download text-sm"></i>
                            </button>
                        </div>
                    `;
                } else if (message.mediaType === 'video') {
                    messageContent = `
                        <div class="relative">
                            <video src="${message.mediaUrl}" controls class="max-w-xs rounded-2xl"></video>
                            <button class="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition-all duration-200" onclick="downloadMedia('${message.mediaUrl}', 'video')">
                                <i class="fas fa-download text-sm"></i>
                            </button>
                        </div>
                    `;
                } else if (message.mediaType === 'audio') {
                    messageContent = `
                        <div class="bg-blue-500 text-white p-4 rounded-2xl relative">
                            <audio src="${message.mediaUrl}" controls class="w-48"></audio>
                            <button class="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition-all duration-200" onclick="downloadMedia('${message.mediaUrl}', 'audio')">
                                <i class="fas fa-download text-sm"></i>
                            </button>
                        </div>
                    `;
                }
            } else {
                // Gestion des messages longs avec troncature
                const isExpanded = expandedMessages.has(messageId);
                const shouldTruncate = message.text && (message.text.length > 150 || message.text.split('\n').length > 4);
                
                let displayText = message.text || '';
                let showMoreButton = '';
                
                if (shouldTruncate && !isExpanded) {
                    displayText = message.text.substring(0, 150) + (message.text.length > 150 ? '...' : '');
                    if (message.text.split('\n').length > 4) {
                        displayText = message.text.split('\n').slice(0, 4).join('\n') + '...';
                    }
                    showMoreButton = `<button class="text-blue-500 text-xs mt-1" onclick="toggleMessageExpansion('${messageId}')">Voir plus</button>`;
                } else if (shouldTruncate && isExpanded) {
                    showMoreButton = `<button class="text-blue-500 text-xs mt-1" onclick="toggleMessageExpansion('${messageId}')">Voir moins</button>`;
                }
                
                messageContent = `
                    <div class="bg-white dark:bg-gray-700 text-gray-800 dark:text-white px-4 py-2 rounded-2xl max-w-xs break-words">
                        <div class="${shouldTruncate && !isExpanded ? 'message-truncated' : ''}">${displayText}</div>
                        ${showMoreButton}
                    </div>
                `;
            }
            
            // Ajouter la réponse si elle existe
            let replyContent = '';
            if (message.replyTo) {
                const isReplyFromCurrentUser = message.replyTo.senderId === currentUser.uid;
                replyContent = `
                    <div class="mb-1 p-2 bg-gray-100 dark:bg-gray-600 rounded-lg border-l-4 border-blue-500">
                        <p class="text-xs font-medium text-gray-600 dark:text-gray-300">${isReplyFromCurrentUser ? 'Vous' : 'Expéditeur'}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${message.replyTo.text}</p>
                    </div>
                `;
            }
            
            // Ajouter les indicateurs de statut de lecture
            let statusIndicator = '';
            if (isCurrentUser && message.status) {
                let statusIcon = '';
                let statusColor = 'text-gray-400';
                
                switch (message.status) {
                    case 'sent':
                        statusIcon = '✓';
                        break;
                    case 'delivered':
                        statusIcon = '✓✓';
                        break;
                    case 'read':
                        statusIcon = '✓✓';
                        statusColor = 'text-blue-500';
                        break;
                }
                
                statusIndicator = `<span class="text-xs ${statusColor} ml-2">${statusIcon}</span>`;
            }
            
            messageElement.innerHTML = `
                <div class="max-w-xs">
                    ${replyContent}
                    ${messageContent}
                    <div class="flex items-center justify-end mt-1">
                        <p class="text-xs text-gray-500 dark:text-gray-400">${formatTime(message.timestamp)}</p>
                        ${statusIndicator}
                    </div>
                </div>
            `;
            
            // Ajouter le menu contextuel avec restriction temporelle
            messageElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showMessageContextMenu(e, message, messageId, isCurrentUser);
            });
            
            elements.messagesContainer.appendChild(messageElement);
        }

        function updateMessage(message, messageId) {
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                messageElement.remove();
                displayMessage(message, messageId);
            }
        }

        function removeMessage(messageId) {
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                messageElement.remove();
            }
        }

        // Fonction pour basculer l'affichage des messages longs
        function toggleMessageExpansion(messageId) {
            if (expandedMessages.has(messageId)) {
                expandedMessages.delete(messageId);
            } else {
                expandedMessages.add(messageId);
            }
            
            // Recharger le message spécifique
            if (currentChat) {
                db.collection('chats').doc(currentChat.id).collection('messages').doc(messageId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const messageElement = document.getElementById(`message-${messageId}`);
                            if (messageElement) {
                                messageElement.remove();
                                displayMessage(doc.data(), messageId);
                            }
                        }
                    });
            }
        }

        function handleMessageInput() {
            const hasText = elements.messageInput.value.trim().length > 0;
            elements.micBtn.classList.toggle('hidden', hasText);
            elements.sendBtn.classList.toggle('hidden', !hasText);
            
            // Ajuster la hauteur automatiquement
            elements.messageInput.style.height = 'auto';
            elements.messageInput.style.height = elements.messageInput.scrollHeight + 'px';
        }

        function handleMessageKeypress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const text = elements.messageInput.value.trim();
            if (!text || !currentChat) return;
            
            try {
                const message = {
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'sent' // Statut initial
                };
                
                // Ajouter la réponse si elle existe
                if (replyingToMessage) {
                    message.replyTo = {
                        messageId: replyingToMessage.id,
                        senderId: replyingToMessage.senderId,
                        text: replyingToMessage.text
                    };
                }
                
                await db.collection('chats').doc(currentChat.id).collection('messages').add(message);
                
                // Mettre à jour le dernier message
                await db.collection('chats').doc(currentChat.id).update({
                    lastMessage: text,
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Réinitialiser l'interface
                elements.messageInput.value = '';
                elements.messageInput.style.height = 'auto';
                cancelReply();
                handleMessageInput();
                
            } catch (error) {
                showToast('Erreur lors de l\'envoi du message: ' + error.message, 'error');
            }
        }

        // =====================================================
        // ENREGISTREMENT VOCAL AVEC AMÉLIORATIONS
        // =====================================================

        function handleVoiceRecordingStart(e) {
            if (e.type === 'touchstart') {
                voiceRecordingStartY = e.touches[0].clientY;
            }
            startVoiceRecording(e);
        }

        function handleVoiceRecordingMove(e) {
            if (!isRecording) return;
            
            let currentY;
            if (e.type === 'mousemove') {
                currentY = e.clientY;
            } else if (e.type === 'touchmove') {
                currentY = e.touches[0].clientY;
            }
            
            // Vérifier le geste de glissement vers le haut
            if (voiceRecordingStartY - currentY > 50 && !isVoiceLocked) {
                isVoiceLocked = true;
                elements.voiceRecorder.classList.add('voice-recorder-locked');
                showToast('Microphone verrouillé - Mode mains libres', 'info');
            }
        }

        async function startVoiceRecording(e) {
            e.preventDefault();
            if (!currentChat) {
                showToast('Veuillez d\'abord sélectionner une conversation', 'error');
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Afficher l'interface d'enregistrement
                elements.voiceRecorder.classList.remove('hidden');
                elements.messageInput.classList.add('hidden');
                
            } catch (error) {
                showToast('Erreur d\'accès au microphone: ' + error.message, 'error');
            }
        }

        function stopVoiceRecording() {
            if (!isRecording || !mediaRecorder) return;
            
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            isRecording = false;
            
            // Si l'enregistrement est verrouillé, afficher la prévisualisation
            if (isVoiceLocked) {
                showVoicePreview();
            } else if (audioChunks.length > 0) {
                // Sinon, envoyer automatiquement
                sendVoiceRecording();
            } else {
                resetVoiceRecorder();
            }
        }

        function showVoicePreview() {
            elements.voiceRecorder.classList.add('hidden');
            elements.voicePreview.classList.remove('hidden');
            
            // Créer l'audio pour la prévisualisation
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            audioPreview = URL.createObjectURL(audioBlob);
        }

        function toggleAudioPreview() {
            if (!audioPreview) return;
            
            const audio = new Audio(audioPreview);
            
            if (isPlayingPreview) {
                audio.pause();
                audio.currentTime = 0;
                elements.playPreview.innerHTML = '<i class="fas fa-play text-xl"></i>';
                isPlayingPreview = false;
            } else {
                audio.play();
                elements.playPreview.innerHTML = '<i class="fas fa-pause text-xl"></i>';
                isPlayingPreview = true;
                
                audio.onended = () => {
                    elements.playPreview.innerHTML = '<i class="fas fa-play text-xl"></i>';
                    isPlayingPreview = false;
                };
            }
        }

        function cancelVoicePreview() {
            elements.voicePreview.classList.add('hidden');
            elements.messageInput.classList.remove('hidden');
            resetVoiceRecorder();
        }

        async function confirmSendVoiceRecording() {
            if (audioChunks.length === 0) return;
            
            try {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const result = await uploadToCloudinary(audioBlob, 'video');
                
                const message = {
                    senderId: currentUser.uid,
                    mediaUrl: result.secure_url,
                    mediaType: 'audio',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'sent'
                };
                
                await db.collection('chats').doc(currentChat.id).collection('messages').add(message);
                
                // Mettre à jour le dernier message
                await db.collection('chats').doc(currentChat.id).update({
                    lastMessage: '🎤 Message audio',
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Message audio envoyé', 'success');
                
            } catch (error) {
                showToast('Erreur lors de l\'envoi de l\'audio: ' + error.message, 'error');
            } finally {
                elements.voicePreview.classList.add('hidden');
                elements.messageInput.classList.remove('hidden');
                resetVoiceRecorder();
            }
        }

        async function sendVoiceRecording() {
            if (audioChunks.length === 0) return;
            
            try {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const result = await uploadToCloudinary(audioBlob, 'video');
                
                const message = {
                    senderId: currentUser.uid,
                    mediaUrl: result.secure_url,
                    mediaType: 'audio',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'sent'
                };
                
                await db.collection('chats').doc(currentChat.id).collection('messages').add(message);
                
                // Mettre à jour le dernier message
                await db.collection('chats').doc(currentChat.id).update({
                    lastMessage: '🎤 Message audio',
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Message audio envoyé', 'success');
                
            } catch (error) {
                showToast('Erreur lors de l\'envoi de l\'audio: ' + error.message, 'error');
            } finally {
                resetVoiceRecorder();
            }
        }

        function resetVoiceRecorder() {
            elements.voiceRecorder.classList.add('hidden');
            elements.voicePreview.classList.add('hidden');
            elements.messageInput.classList.remove('hidden');
            isRecording = false;
            isVoiceLocked = false;
            isPlayingPreview = false;
            audioChunks = [];
            mediaRecorder = null;
            
            if (audioPreview) {
                URL.revokeObjectURL(audioPreview);
                audioPreview = null;
            }
        }

        // =====================================================
        // ÉDITEUR DE MÉDIA AVEC OUTILS AVANCÉS
        // =====================================================

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Vérifier le type de fichier
            if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                showToast('Type de fichier non supporté', 'error');
                return;
            }
            
            // Pour les images, ouvrir l'éditeur
            if (file.type.startsWith('image/')) {
                openMediaEditor(file);
            } else {
                // Pour les vidéos, upload directement
                try {
                    const resourceType = file.type.startsWith('video/') ? 'video' : 'auto';
                    const result = await uploadToCloudinary(file, resourceType);
                    
                    const message = {
                        senderId: currentUser.uid,
                        mediaUrl: result.secure_url,
                        mediaType: resourceType,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'sent'
                    };
                    
                    await db.collection('chats').doc(currentChat.id).collection('messages').add(message);
                    
                    showToast('Fichier envoyé', 'success');
                    
                } catch (error) {
                    showToast('Erreur lors de l\'envoi du fichier: ' + error.message, 'error');
                }
            }
            
            // Réinitialiser l'input
            event.target.value = '';
        }

        function openMediaEditor(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                elements.mediaPreview.src = e.target.result;
                elements.mediaEditorModal.classList.remove('hidden');
                
                // Redimensionner le canvas
                const img = new Image();
                img.onload = function() {
                    elements.drawingCanvas.width = img.width;
                    elements.drawingCanvas.height = img.height;
                    
                    const ctx = elements.drawingCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                };
                img.src = e.target.result;
                
                currentMediaFile = file;
            };
            reader.readAsDataURL(file);
        }

        function closeMediaEditor() {
            elements.mediaEditorModal.classList.add('hidden');
            elements.textInputContainer.classList.add('hidden');
            elements.filterContainer.classList.add('hidden');
            currentMediaFile = null;
        }

        function activateDrawTool() {
            elements.textInputContainer.classList.add('hidden');
            elements.filterContainer.classList.add('hidden');
            setupDrawingCanvas();
        }

        function activateTextTool() {
            elements.textInputContainer.classList.remove('hidden');
            elements.filterContainer.classList.add('hidden');
        }

        function activateCropTool() {
            // Implémentation basique du recadrage
            showToast('Fonction de recadrage activée', 'info');
            elements.textInputContainer.classList.add('hidden');
            elements.filterContainer.classList.add('hidden');
        }

        function activateFilterTool() {
            elements.textInputContainer.classList.add('hidden');
            elements.filterContainer.classList.remove('hidden');
        }

        function setupDrawingCanvas() {
            const canvas = elements.drawingCanvas;
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                ctx.strokeStyle = elements.drawingColor.value;
                ctx.lineWidth = 5;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
        }

        function applyFilter(filter) {
            const canvas = elements.drawingCanvas;
            const ctx = canvas.getContext('2d');
            
            // Réappliquer l'image originale
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                
                // Appliquer le filtre
                switch (filter) {
                    case 'grayscale':
                        ctx.globalCompositeOperation = 'saturation';
                        ctx.fillStyle = 'hsl(0, 0%, 50%)';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.globalCompositeOperation = 'source-over';
                        break;
                    case 'sepia':
                        ctx.globalCompositeOperation = 'color';
                        ctx.fillStyle = 'hsl(35, 100%, 50%)';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.globalCompositeOperation = 'source-over';
                        break;
                    // Ajouter d'autres filtres ici
                }
            };
            img.src = elements.mediaPreview.src;
        }

        function clearCanvas() {
            const ctx = elements.drawingCanvas.getContext('2d');
            ctx.clearRect(0, 0, elements.drawingCanvas.width, elements.drawingCanvas.height);
            
            // Redessiner l'image originale
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
            };
            img.src = elements.mediaPreview.src;
        }

        function updateDrawingColor() {
            // La couleur est automatiquement utilisée dans la fonction draw
        }

        async function sendEditedMedia() {
            if (!currentMediaFile) return;
            
            try {
                // Fusionner l'image et le canvas
                const canvas = document.createElement('canvas');
                canvas.width = elements.drawingCanvas.width;
                canvas.height = elements.drawingCanvas.height;
                const ctx = canvas.getContext('2d');
                
                // Dessiner l'image originale
                const img = new Image();
                await new Promise((resolve) => {
                    img.onload = resolve;
                    img.src = elements.mediaPreview.src;
                });
                ctx.drawImage(img, 0, 0);
                
                // Dessiner les annotations
                ctx.drawImage(elements.drawingCanvas, 0, 0);
                
                // Ajouter le texte s'il existe
                if (elements.textInput.value.trim()) {
                    ctx.font = '24px Arial';
                    ctx.fillStyle = elements.drawingColor.value;
                    ctx.fillText(elements.textInput.value, 20, 40);
                }
                
                // Convertir en blob et upload
                canvas.toBlob(async (blob) => {
                    const editedFile = new File([blob], currentMediaFile.name, { type: currentMediaFile.type });
                    const result = await uploadToCloudinary(editedFile, 'image');
                    
                    const message = {
                        senderId: currentUser.uid,
                        mediaUrl: result.secure_url,
                        mediaType: 'image',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'sent'
                    };
                    
                    await db.collection('chats').doc(currentChat.id).collection('messages').add(message);
                    
                    showToast('Image envoyée', 'success');
                    closeMediaEditor();
                    
                }, currentMediaFile.type);
                
            } catch (error) {
                showToast('Erreur lors de l\'envoi de l\'image: ' + error.message, 'error');
            }
        }

        function downloadEditedMedia() {
            const canvas = elements.drawingCanvas;
            const link = document.createElement('a');
            link.download = 'image-editee.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // =====================================================
        // FONCTIONNALITÉS AVANCÉES DES MESSAGES
        // =====================================================

        function showMessageContextMenu(event, message, messageId, isCurrentUser) {
            // Vérifier si le message peut être modifié (moins de 10 minutes)
            const canEdit = isCurrentUser && canMessageBeEdited(message.timestamp);
            
            // Créer le menu contextuel
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';
            
            let menuItems = `
                <div class="context-menu-item" data-action="copy">
                    <i class="fas fa-copy mr-2"></i>Copier
                </div>
                <div class="context-menu-item" data-action="reply">
                    <i class="fas fa-reply mr-2"></i>Répondre
                </div>
            `;
            
            // Ajouter l'option de téléchargement pour les médias
            if (message.mediaUrl) {
                menuItems += `
                    <div class="context-menu-item" data-action="download">
                        <i class="fas fa-download mr-2"></i>Télécharger
                    </div>
                `;
            }
            
            if (isCurrentUser) {
                if (canEdit) {
                    menuItems += `
                        <div class="context-menu-item" data-action="edit">
                            <i class="fas fa-edit mr-2"></i>Modifier
                        </div>
                    `;
                }
                // La suppression est toujours disponible pour l'auteur
                menuItems += `
                    <div class="context-menu-item text-red-500" data-action="delete">
                        <i class="fas fa-trash mr-2"></i>Supprimer
                    </div>
                `;
            }
            
            menu.innerHTML = menuItems;
            document.body.appendChild(menu);
            
            // Gérer les clics sur les éléments du menu
            menu.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.dataset.action;
                    handleMessageAction(action, message, messageId);
                    menu.remove();
                });
            });
            
            // Fermer le menu en cliquant ailleurs
            document.addEventListener('click', function closeMenu() {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            });
        }

        function canMessageBeEdited(timestamp) {
            if (!timestamp) return false;
            
            const messageTime = timestamp.toDate().getTime();
            const currentTime = new Date().getTime();
            const tenMinutes = 10 * 60 * 1000; // 10 minutes en millisecondes
            
            return (currentTime - messageTime) < tenMinutes;
        }

        function handleMessageAction(action, message, messageId) {
            switch (action) {
                case 'copy':
                    navigator.clipboard.writeText(message.text)
                        .then(() => showToast('Message copié', 'success'))
                        .catch(() => showToast('Erreur lors de la copie', 'error'));
                    break;
                    
                case 'reply':
                    setReplyToMessage(message, messageId);
                    break;
                    
                case 'download':
                    downloadMedia(message.mediaUrl, message.mediaType);
                    break;
                    
                case 'edit':
                    editMessage(message, messageId);
                    break;
                    
                case 'delete':
                    deleteMessage(messageId);
                    break;
            }
        }

        function setReplyToMessage(message, messageId) {
            replyingToMessage = {
                id: messageId,
                senderId: message.senderId,
                text: message.text
            };
            
            elements.replyUserName.textContent = message.senderId === currentUser.uid ? 'Vous' : 'Expéditeur';
            elements.replyMessageText.textContent = message.text;
            elements.replyIndicator.classList.remove('hidden');
            
            // Focus sur l'input
            elements.messageInput.focus();
        }

        function cancelReply() {
            replyingToMessage = null;
            elements.replyIndicator.classList.add('hidden');
        }

        function editMessage(message, messageId) {
            elements.messageInput.value = message.text;
            elements.messageInput.focus();
            // Implémenter la logique de mise à jour du message
        }

        async function deleteMessage(messageId) {
            if (!confirm('Supprimer ce message ?')) return;
            
            try {
                await db.collection('chats').doc(currentChat.id).collection('messages').doc(messageId).delete();
                showToast('Message supprimé', 'success');
            } catch (error) {
                showToast('Erreur lors de la suppression: ' + error.message, 'error');
            }
        }

        // =====================================================
        // FONCTIONNALITÉS DES GROUPES - CORRECTION REDIRECTION
        // =====================================================

        function showCreateGroupModal() {
            elements.createGroupModal.classList.remove('hidden');
        }

        function hideCreateGroupModal() {
            elements.createGroupModal.classList.add('hidden');
            elements.groupName.value = '';
            elements.groupDescription.value = '';
        }

        async function createGroup() {
            const name = elements.groupName.value.trim();
            const description = elements.groupDescription.value.trim();
            
            if (!name) {
                showToast('Le nom du groupe est requis', 'error');
                return;
            }
            
            try {
                let photoURL = '';
                
                // Upload de la photo si elle existe
                if (elements.groupPhoto.files[0]) {
                    const result = await uploadToCloudinary(elements.groupPhoto.files[0], 'image');
                    photoURL = result.secure_url;
                }
                
                // Créer le groupe dans Firestore
                const groupRef = await db.collection('groups').add({
                    name: name,
                    description: description,
                    photoURL: photoURL,
                    admins: [currentUser.uid],
                    members: [currentUser.uid],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: '',
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Groupe créé avec succès', 'success');
                hideCreateGroupModal();
                
                // Rediriger immédiatement vers le chat du groupe
                await openGroupChat(groupRef.id, name);
                
            } catch (error) {
                showToast('Erreur lors de la création du groupe: ' + error.message, 'error');
            }
        }

        async function openGroupChat(groupId, groupName) {
            try {
                currentGroup = {
                    id: groupId,
                    name: groupName
                };
                
                // Masquer la vue des groupes
                elements.groupsView.classList.add('hidden');
                
                // Afficher la vue de chat de groupe
                elements.groupChatView.classList.remove('translate-x-full');
                
                // Charger les messages du groupe
                loadGroupMessages(groupId);
                
                showToast(`Ouverture du groupe ${groupName}`, 'success');
                
            } catch (error) {
                showToast('Erreur lors de l\'ouverture du groupe: ' + error.message, 'error');
            }
        }

        function handleGroupPhotoChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Ici, vous pouvez afficher un aperçu de la photo
            showToast('Photo sélectionnée', 'info');
        }

        async function performGroupSearch() {
            const query = elements.searchGroups.value.trim();
            if (!query) {
                loadGroupsList();
                return;
            }
            
            try {
                const snapshot = await db.collection('groups')
                    .where('name', '>=', query)
                    .where('name', '<=', query + '\uf8ff')
                    .get();
                
                elements.groupsList.innerHTML = '';
                
                if (snapshot.empty) {
                    elements.groupsList.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">Aucun groupe trouvé</p>
                        </div>
                    `;
                    return;
                }
                
                // Utiliser un Set pour éviter les doublons
                const displayedGroups = new Set();
                
                snapshot.forEach(doc => {
                    const group = doc.data();
                    if (displayedGroups.has(doc.id)) return;
                    
                    displayedGroups.add(doc.id);
                    const groupItem = createGroupListItem(group, doc.id);
                    elements.groupsList.appendChild(groupItem);
                });
            } catch (error) {
                console.error('Erreur de recherche de groupes:', error);
            }
        }

        function createGroupListItem(group, groupId) {
            const div = document.createElement('div');
            div.className = 'glass rounded-2xl p-4 flex items-center space-x-3 cursor-pointer hover:bg-white dark:hover:bg-gray-700 transition-colors duration-200';
            div.innerHTML = `
                <img src="${group.photoURL || 'https://via.placeholder.com/50'}" alt="${group.name}" class="w-12 h-12 rounded-xl">
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-800 dark:text-white">${group.name}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${group.description || 'Aucune description'}</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500 dark:text-gray-400">${group.members ? group.members.length : 0} membres</p>
                    <button class="mt-1 px-3 py-1 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600 transition-colors duration-200">
                        Rejoindre
                    </button>
                </div>
            `;
            
            div.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                joinGroup(groupId, group.name);
            });
            
            div.addEventListener('click', () => openGroupChat(groupId, group.name));
            return div;
        }

        async function joinGroup(groupId, groupName) {
            try {
                await db.collection('groups').doc(groupId).update({
                    members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
                
                showToast('Vous avez rejoint le groupe', 'success');
                openGroupChat(groupId, groupName);
            } catch (error) {
                showToast('Erreur lors de la jonction au groupe: ' + error.message, 'error');
            }
        }

        // =====================================================
        // RECHERCHE DE MESSAGES DANS LE CHAT
        // =====================================================

        function showChatInfoPanel() {
            elements.chatInfoPanel.classList.remove('translate-x-full');
            loadChatInfo();
        }

        function hideChatInfoPanel() {
            elements.chatInfoPanel.classList.add('translate-x-full');
        }

        function loadChatInfo() {
            if (!currentChat) return;
            
            // Charger les informations du chat
            elements.chatInfoContent.innerHTML = `
                <div class="glass rounded-2xl p-4 mb-4">
                    <div class="flex items-center space-x-3 mb-4">
                        <img src="${elements.chatUserAvatar.src}" alt="${elements.chatUserName.textContent}" class="w-16 h-16 rounded-xl">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">${elements.chatUserName.textContent}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${elements.chatUserStatus.textContent}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function performMessageSearch() {
            const query = elements.searchMessages.value.trim();
            if (!query || !currentChat) return;
            
            try {
                const snapshot = await db.collection('chats').doc(currentChat.id).collection('messages')
                    .where('text', '>=', query)
                    .where('text', '<=', query + '\uf8ff')
                    .get();
                
                elements.searchResults.innerHTML = '';
                
                if (snapshot.empty) {
                    elements.searchResults.innerHTML = `
                        <div class="text-center py-4">
                            <p class="text-gray-500 dark:text-gray-400">Aucun message trouvé</p>
                        </div>
                    `;
                    return;
                }
                
                // Utiliser un Set pour éviter les doublons
                const displayedMessages = new Set();
                
                snapshot.forEach(doc => {
                    if (displayedMessages.has(doc.id)) return;
                    
                    displayedMessages.add(doc.id);
                    const resultItem = createSearchResultItem(doc.data(), doc.id, query);
                    elements.searchResults.appendChild(resultItem);
                });
            } catch (error) {
                console.error('Erreur de recherche de messages:', error);
            }
        }

        function createSearchResultItem(message, messageId, query) {
            const div = document.createElement('div');
            div.className = 'glass rounded-xl p-3 cursor-pointer hover:bg-white dark:hover:bg-gray-700 transition-colors duration-200';
            
            // Mettre en évidence le terme de recherche
            let highlightedText = message.text;
            const regex = new RegExp(query, 'gi');
            highlightedText = highlightedText.replace(regex, match => 
                `<span class="search-highlight">${match}</span>`
            );
            
            div.innerHTML = `
                <p class="text-sm text-gray-800 dark:text-white">${highlightedText}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${formatTime(message.timestamp)}</p>
            `;
            
            div.addEventListener('click', () => {
                // Faire défiler jusqu'au message dans le chat
                hideChatInfoPanel();
                scrollToMessage(messageId);
            });
            
            return div;
        }

        function scrollToMessage(messageId) {
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Ajouter un effet de surbrillance temporaire
                messageElement.classList.add('bg-yellow-100', 'dark:bg-yellow-900');
                setTimeout(() => {
                    messageElement.classList.remove('bg-yellow-100', 'dark:bg-yellow-900');
                }, 2000);
            }
        }

        // =====================================================
        // APPELS WEBRTC
        // =====================================================

        async function startCall(type) {
            if (!currentChat) return;
            
            try {
                // Obtenir le flux média local
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: type === 'video'
                });
                
                // Créer la connexion peer
                peerConnection = new RTCPeerConnection(ICE_SERVERS);
                
                // Ajouter les tracks locaux
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Gérer les streams distants
                peerConnection.ontrack = (event) => {
                    remoteStream = event.streams[0];
                    elements.remoteVideo.srcObject = remoteStream;
                };
                
                // Créer l'offre
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Créer le document d'appel dans Firestore
                currentCallDoc = db.collection('calls').doc();
                await currentCallDoc.set({
                    offer: offer,
                    from: currentUser.uid,
                    to: currentChat.otherUserId,
                    type: type,
                    status: 'calling',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Écouter les candidats ICE
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        currentCallDoc.collection('callerCandidates').add(event.candidate.toJSON());
                    }
                };
                
                // Écouter la réponse
                currentCallDoc.collection('calleeCandidates').onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const candidate = new RTCIceCandidate(change.doc.data());
                            peerConnection.addIceCandidate(candidate);
                        }
                    });
                });
                
                currentCallDoc.onSnapshot(async (doc) => {
                    const data = doc.data();
                    if (data.answer && peerConnection.signalingState !== 'stable') {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                });
                
                // Afficher l'interface d'appel
                showCallInterface(type);
                
            } catch (error) {
                showToast('Erreur lors du démarrage de l\'appel: ' + error.message, 'error');
            }
        }

        function showCallInterface(type) {
            elements.callInterface.classList.remove('hidden');
            elements.localVideo.srcObject = localStream;
            elements.callUserName.textContent = currentChat.name;
            elements.callStatus.textContent = type === 'video' ? 'Appel vidéo en cours...' : 'Appel audio en cours...';
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (currentCallDoc) {
                currentCallDoc.update({ status: 'ended' });
                currentCallDoc = null;
            }
            
            elements.callInterface.classList.add('hidden');
        }

        function toggleMute() {
            if (!localStream) return;
            
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                const enabled = !audioTracks[0].enabled;
                audioTracks[0].enabled = enabled;
                
                elements.callMute.innerHTML = enabled ? 
                    '<i class="fas fa-microphone"></i>' : 
                    '<i class="fas fa-microphone-slash"></i>';
            }
        }

        // Écouter les appels entrants
        function setupIncomingCallsListener() {
            unsubscribeCallsListener = db.collection('calls')
                .where('to', '==', currentUser.uid)
                .where('status', '==', 'calling')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            showIncomingCall(change.doc);
                        }
                    });
                });
        }

        function showIncomingCall(callDoc) {
            const callData = callDoc.data();
            currentCallDoc = callDoc.ref;
            
            elements.incomingCallName.textContent = 'Appel entrant';
            elements.incomingCallType.textContent = callData.type === 'video' ? 'Appel vidéo' : 'Appel audio';
            elements.incomingCall.classList.remove('hidden');
        }

        async function acceptIncomingCall() {
            elements.incomingCall.classList.add('hidden');
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: currentCallDoc.data().type === 'video'
                });
                
                peerConnection = new RTCPeerConnection(ICE_SERVERS);
                
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                peerConnection.ontrack = (event) => {
                    remoteStream = event.streams[0];
                    elements.remoteVideo.srcObject = remoteStream;
                };
                
                const callData = currentCallDoc.data();
                await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                await currentCallDoc.update({
                    answer: answer,
                    status: 'in-progress'
                });
                
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        currentCallDoc.collection('calleeCandidates').add(event.candidate.toJSON());
                    }
                };
                
                currentCallDoc.collection('callerCandidates').onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const candidate = new RTCIceCandidate(change.doc.data());
                            peerConnection.addIceCandidate(candidate);
                        }
                    });
                });
                
                showCallInterface(callData.type);
                
            } catch (error) {
                showToast('Erreur lors de l\'acceptation de l\'appel: ' + error.message, 'error');
            }
        }

        function declineIncomingCall() {
            if (currentCallDoc) {
                currentCallDoc.update({ status: 'declined' });
                currentCallDoc = null;
            }
            elements.incomingCall.classList.add('hidden');
        }

        // =====================================================
        // FONCTIONS UTILITAIRES
        // =====================================================

        function uploadToCloudinary(file, resourceType) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);
                
                fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${resourceType}/upload`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur de téléversement Cloudinary');
                    }
                    return response.json();
                })
                .then(data => {
                    resolve(data);
                })
                .catch(error => {
                    reject(error);
                });
            });
        }

        function downloadMedia(url, type) {
            const link = document.createElement('a');
            link.href = url;
            link.download = `privcon-${type}-${Date.now()}.${type === 'audio' ? 'mp3' : type === 'video' ? 'mp4' : 'jpg'}`;
            link.click();
            showToast('Téléchargement démarré', 'success');
        }

        function openImageModal(url) {
            // Implémentation basique d'une modale d'image
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="max-w-4xl max-h-full p-4">
                    <img src="${url}" alt="Image" class="max-w-full max-h-full object-contain">
                    <button class="absolute top-4 right-4 text-white text-2xl" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="absolute top-4 left-4 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition-all duration-200" onclick="downloadMedia('${url}', 'image')">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Fermer la modale en cliquant à l'extérieur
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            }[type];
            
            toast.className = `${bgColor} text-white px-6 py-3 rounded-2xl shadow-lg transform animate-fade-in`;
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="fas fa-${getToastIcon(type)}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            elements.toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function getToastIcon(type) {
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = timestamp.toDate();
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Maintenant';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            if (diffDays < 7) return `${diffDays}j`;
            
            return date.toLocaleDateString();
        }

        function scrollToBottom() {
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // =====================================================
        // ÉCOUTEURS EN TEMPS RÉEL
        // =====================================================

        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            // Mettre à jour le statut en ligne
            db.collection('users').doc(currentUser.uid).update({
                isOnline: true,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Écouter les changements de statut des utilisateurs
            unsubscribeUsersListener = db.collection('users').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'modified') {
                        // Mettre à jour les statuts en temps réel
                        const user = change.doc.data();
                        if (currentChat && currentChat.otherUserId === user.uid) {
                            elements.chatUserStatus.textContent = user.isOnline ? 'En ligne' : 'Hors ligne';
                        }
                    }
                });
            });
            
            // Écouter les appels entrants
            setupIncomingCallsListener();
            
            // Mettre à jour le statut hors ligne lors de la fermeture
            window.addEventListener('beforeunload', () => {
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).update({
                        isOnline: false,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Nettoyer tous les listeners
                cleanupListeners();
            });
        }

        // =====================================================
        // FONCTIONS DE CHARGEMENT DES DONNÉES
        // =====================================================

        async function loadChatsList() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.collection('chats')
                    .where('participants', 'array-contains', currentUser.uid)
                    .orderBy('lastMessageTime', 'desc')
                    .get();
                
                // Vider le conteneur avant d'ajouter de nouveaux éléments
                elements.chatsList.innerHTML = '';
                
                if (snapshot.empty) {
                    elements.chatsList.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-comments text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">Aucune conversation</p>
                            <p class="text-sm text-gray-400 dark:text-gray-500">Commencez une nouvelle conversation en recherchant un utilisateur</p>
                        </div>
                    `;
                    return;
                }
                
                // Utiliser un Set pour éviter les doublons
                const displayedChats = new Set();
                
                for (const doc of snapshot.docs) {
                    if (displayedChats.has(doc.id)) continue;
                    
                    displayedChats.add(doc.id);
                    const chat = doc.data();
                    const otherUserId = chat.participants.find(id => id !== currentUser.uid);
                    const userDoc = await db.collection('users').doc(otherUserId).get();
                    
                    if (userDoc.exists) {
                        const user = userDoc.data();
                        const chatItem = createChatListItem(chat, user);
                        elements.chatsList.appendChild(chatItem);
                    }
                }
                
            } catch (error) {
                console.error('Erreur lors du chargement des conversations:', error);
            }
        }

        function createChatListItem(chat, user) {
            const div = document.createElement('div');
            div.className = 'glass rounded-2xl p-4 flex items-center space-x-3 cursor-pointer hover:bg-white dark:hover:bg-gray-700 transition-colors duration-200';
            div.innerHTML = `
                <img src="${user.photoURL || 'https://via.placeholder.com/50'}" alt="${user.username}" class="w-12 h-12 rounded-xl">
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-800 dark:text-white">${user.username}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${chat.lastMessage || 'Aucun message'}</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500 dark:text-gray-400">${formatTime(chat.lastMessageTime)}</p>
                    <div class="w-3 h-3 rounded-full ${user.isOnline ? 'bg-green-500' : 'bg-gray-400'} mt-1"></div>
                </div>
            `;
            
            div.addEventListener('click', () => openChatWithUser(user.uid, user.username));
            return div;
        }

        async function loadCallsHistory() {
            // Implémentation de l'historique des appels
        }

        async function loadGroupsList() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.collection('groups')
                    .where('members', 'array-contains', currentUser.uid)
                    .orderBy('lastMessageTime', 'desc')
                    .get();
                
                // Vider le conteneur avant d'ajouter de nouveaux éléments
                elements.groupsList.innerHTML = '';
                
                if (snapshot.empty) {
                    elements.groupsList.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">Aucun groupe</p>
                            <p class="text-sm text-gray-400 dark:text-gray-500">Rejoignez ou créez un groupe pour commencer</p>
                        </div>
                    `;
                    return;
                }
                
                // Utiliser un Set pour éviter les doublons
                const displayedGroups = new Set();
                
                snapshot.forEach(doc => {
                    if (displayedGroups.has(doc.id)) return;
                    
                    displayedGroups.add(doc.id);
                    const group = doc.data();
                    const groupItem = createGroupListItem(group, doc.id);
                    elements.groupsList.appendChild(groupItem);
                });
            } catch (error) {
                console.error('Erreur lors du chargement des groupes:', error);
            }
        }

        // Fonction pour charger les messages de groupe
        async function loadGroupMessages(groupId) {
            // Implémentation similaire à loadChatMessages mais pour les groupes
        }

        // Initialisation finale
        initializeApp();
    </script>
</body>
</html>
